name: Validate Input CSVs

on:
  workflow_run:
    workflows:
      - "Generate Record Metadata CSVs"
      - "Create Records"
    types: [completed]

  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch containing files to validate'
        required: true
        type: string
      validation_mode:
        description: 'Which validation to run'
        required: true
        type: choice
        default: 'both'
        options:
          - csv
          - json
          - both

jobs:
  validate-csvs:
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' &&
       (inputs.validation_mode == 'csv' || inputs.validation_mode == 'both'))
      ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.name == 'Generate Record Metadata CSVs')

    steps:
      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target=${{ inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            echo "target=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout target branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.branch.outputs.target }}
          token: ${{ secrets.BOT_TOKEN }}

      - name: Checkout validation tool from curation_ops
        uses: actions/checkout@v6
        with:
          repository: ror-community/curation_ops
          path: curation_ops

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install validation tool
        run: pip install -e curation_ops/curation_validation

      - name: Detect and validate CSVs
        id: validate
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          INPUT_DIR="${TARGET_BRANCH}/input_files"
          OUTPUT_DIR="${TARGET_BRANCH}/validation/csvs"
          CSVS_FOUND=""

          # Detect available CSVs
          for csv in new_records_metadata.csv update_records_metadata.csv; do
            if [ -f "${INPUT_DIR}/${csv}" ]; then
              CSVS_FOUND="${CSVS_FOUND} ${INPUT_DIR}/${csv}"
            fi
          done

          if [ -z "$CSVS_FOUND" ]; then
            echo "::warning::No CSV files found to validate in ${INPUT_DIR}"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          mkdir -p "$OUTPUT_DIR"

          # Validate each CSV (word splitting intentional here)
          for csv in $CSVS_FOUND; do
            BASENAME=$(basename "$csv" .csv)
            echo "::group::Validating ${BASENAME}"

            mkdir -p "${OUTPUT_DIR}/${BASENAME}"

            curation-validation \
              -c "$csv" \
              -o "${OUTPUT_DIR}/${BASENAME}" \
              -u "${{ secrets.GEONAMES_USER }}" || true

            echo "::endgroup::"
          done

      - name: Commit validation reports
        if: ${{ steps.validate.outputs.found == 'true' }}
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${TARGET_BRANCH}/validation/csvs/" || true

          if git diff --staged --quiet; then
            echo "::notice::No validation results to commit"
            exit 0
          fi

          # Count total issues found across all reports
          ISSUE_COUNT=$(find "${TARGET_BRANCH}/validation/csvs" -name "*.csv" -exec tail -n +2 {} \; 2>/dev/null | wc -l | tr -d ' ')

          git commit -m "Add CSV validation reports (${ISSUE_COUNT} issues found) from workflow run #${{ github.run_number }}"
          git pull --rebase origin "${{ steps.branch.outputs.target }}"
          git push

  validate-json:
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' &&
       (inputs.validation_mode == 'json' || inputs.validation_mode == 'both'))
      ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.name == 'Create Records')

    steps:
      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target=${{ inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            echo "target=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout target branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.branch.outputs.target }}
          token: ${{ secrets.BOT_TOKEN }}

      - name: Checkout validation tool from curation_ops
        uses: actions/checkout@v6
        with:
          repository: ror-community/curation_ops
          path: curation_ops

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install validation tool
        run: pip install -e curation_ops/curation_validation

      - name: Validate new records
        id: validate_new
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          NEW_CSV="${TARGET_BRANCH}/validation/create/new_records_with_ids.csv"
          NEW_JSON_DIR="${TARGET_BRANCH}/new"
          OUTPUT_DIR="${TARGET_BRANCH}/validation/json/new_records"

          if [ -d "$NEW_JSON_DIR" ] && ls "$NEW_JSON_DIR"/*.json 1>/dev/null 2>&1; then
            echo "found_new=true" >> $GITHUB_OUTPUT
            mkdir -p "$OUTPUT_DIR"

            echo "::group::Validating new records (JSON + cross-format)"

            if [ -f "$NEW_CSV" ]; then
              curation-validation \
                -c "$NEW_CSV" \
                -j "$NEW_JSON_DIR" \
                -o "$OUTPUT_DIR" \
                -u "${{ secrets.GEONAMES_USER }}" || true
            else
              echo "::warning::new_records_with_ids.csv not found, running JSON-only validation"
              curation-validation \
                -j "$NEW_JSON_DIR" \
                -o "$OUTPUT_DIR" \
                -u "${{ secrets.GEONAMES_USER }}" || true
            fi

            echo "::endgroup::"
          else
            echo "::warning::No new record JSON files found in ${NEW_JSON_DIR}"
            echo "found_new=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate update records
        id: validate_updates
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          UPDATE_CSV="${TARGET_BRANCH}/input_files/update_records_metadata.csv"
          UPDATE_JSON_DIR="${TARGET_BRANCH}/updates"
          OUTPUT_DIR="${TARGET_BRANCH}/validation/json/update_records"

          if [ -d "$UPDATE_JSON_DIR" ] && ls "$UPDATE_JSON_DIR"/*.json 1>/dev/null 2>&1; then
            echo "found_updates=true" >> $GITHUB_OUTPUT
            mkdir -p "$OUTPUT_DIR"

            echo "::group::Validating update records (JSON + cross-format)"

            if [ -f "$UPDATE_CSV" ]; then
              curation-validation \
                -c "$UPDATE_CSV" \
                -j "$UPDATE_JSON_DIR" \
                -o "$OUTPUT_DIR" \
                -u "${{ secrets.GEONAMES_USER }}" || true
            else
              echo "::warning::update_records_metadata.csv not found, running JSON-only validation"
              curation-validation \
                -j "$UPDATE_JSON_DIR" \
                -o "$OUTPUT_DIR" \
                -u "${{ secrets.GEONAMES_USER }}" || true
            fi

            echo "::endgroup::"
          else
            echo "::warning::No update record JSON files found in ${UPDATE_JSON_DIR}"
            echo "found_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit validation reports
        if: >-
          steps.validate_new.outputs.found_new == 'true' ||
          steps.validate_updates.outputs.found_updates == 'true'
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${TARGET_BRANCH}/validation/json/" || true

          if git diff --staged --quiet; then
            echo "::notice::No validation results to commit"
            exit 0
          fi

          # Count total issues found across all reports
          ISSUE_COUNT=$(find "${TARGET_BRANCH}/validation/json" -name "*.csv" -exec tail -n +2 {} \; 2>/dev/null | wc -l | tr -d ' ')

          git commit -m "Add JSON validation reports (${ISSUE_COUNT} issues found) from workflow run #${{ github.run_number }}"
          git pull --rebase origin "${{ steps.branch.outputs.target }}"
          git push
