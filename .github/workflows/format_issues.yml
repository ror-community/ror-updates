name: Format Issues

on:
  schedule:
    - cron: '45 2 * * *'  # Temporary: testing at 02:45 UTC

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Single issue number to format'
        required: false
        type: string
      start_issue:
        description: 'Start issue number for range (requires end_issue)'
        required: false
        type: string
      end_issue:
        description: 'End issue number for range (requires start_issue)'
        required: false
        type: string
      dry_run:
        description: 'Log proposed changes without applying them'
        required: false
        type: boolean
        default: false
      model:
        description: 'AI model to use for formatting (gemini or openai)'
        required: false
        type: choice
        options:
          - gemini
          - openai
        default: gemini

permissions:
  issues: write
  contents: read

jobs:
  format-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific script version from curation_ops
        uses: actions/checkout@v4
        with:
          repository: ror-community/curation_ops

      - name: List files after checkout for path verification
        run: |
          pwd
          ls -la
          if [ -d "format_issues" ]; then
            echo "'format_issues' directory exists. Contents:"
            ls -la format_issues/
          else
            echo "'format_issues' directory DOES NOT exist at the root of the checkout."
          fi

      - name: Set up Python
        id: setup_python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f format_issues/requirements.txt ]; then
            echo "Found format_issues/requirements.txt. Installing dependencies..."
            python -m pip install -r format_issues/requirements.txt
          else
            echo "Could not find format_issues/requirements.txt."
            exit 1
          fi

      - name: Get issues to process (scheduled runs)
        if: github.event_name == 'schedule'
        id: get-issues
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          pip install aiohttp
          ISSUES=$(python get_issues_for_processing/get_issues_for_processing.py \
            --repo "${{ github.repository }}" \
            --required-label "triage needed" \
            --exclude-label "auto-formatted")
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "Found issues: $ISSUES"

      - name: Validate Inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ -n "${{ github.event.inputs.issue_number }}" && ( -n "${{ github.event.inputs.start_issue }}" || -n "${{ github.event.inputs.end_issue }}" ) ]]; then
            echo "Error: Cannot specify both single issue and issue range."
            exit 1
          fi
          if [[ -z "${{ github.event.inputs.issue_number }}" && ( -z "${{ github.event.inputs.start_issue }}" || -z "${{ github.event.inputs.end_issue }}" ) ]]; then
            echo "Error: Must specify either single issue number or both start and end issue numbers for a range."
            exit 1
          fi
          if [[ -n "${{ github.event.inputs.start_issue }}" && -z "${{ github.event.inputs.end_issue }}" ]]; then
            echo "Error: If start_issue is provided, end_issue must also be provided."
            exit 1
          fi
          if [[ -z "${{ github.event.inputs.start_issue }}" && -n "${{ github.event.inputs.end_issue }}" ]]; then
            echo "Error: If end_issue is provided, start_issue must also be provided."
            exit 1
          fi
          echo "Input validation passed."

      - name: Process issues
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPO_PATH: ${{ github.repository }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          MODEL: ${{ github.event.inputs.model || 'gemini' }}
        run: |
          # Determine which issues to process
          if [ "${{ github.event_name }}" = "schedule" ]; then
            ISSUES="${{ steps.get-issues.outputs.issues }}"
            if [ -z "$ISSUES" ]; then
              echo "No issues to process from scheduled query"
              exit 0
            fi
          elif [ -n "${{ github.event.inputs.issue_number }}" ]; then
            ISSUES="${{ github.event.inputs.issue_number }}"
          else
            ISSUES=$(seq ${{ github.event.inputs.start_issue }} ${{ github.event.inputs.end_issue }})
          fi

          echo "Processing issues: $ISSUES"

          for ISSUE in $ISSUES; do
            echo ""
            echo "========================================"
            echo "Processing issue #$ISSUE"
            echo "========================================"

            # Run formatting script for single issue
            ISSUE_NUMBER=$ISSUE python format_issues/format_issues.py

            # Add label on success
            if [ $? -eq 0 ]; then
              gh issue edit $ISSUE --add-label "auto-formatted" --repo ${{ github.repository }}
              echo "Added auto-formatted label to issue #$ISSUE"
            else
              echo "::warning::Failed to process issue #$ISSUE"
            fi
          done

          echo ""
          echo "Processing complete"
