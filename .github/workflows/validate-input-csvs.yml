name: Validate Input CSVs

on:
  workflow_run:
    workflows: ["Generate Record Metadata CSVs"]
    types: [completed]

  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch containing CSVs to validate'
        required: true
        type: string

jobs:
  validate-csvs:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target=${{ inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            # For workflow_run, get branch from the triggering workflow
            echo "target=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout target branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.branch.outputs.target }}
          token: ${{ secrets.BOT_TOKEN }}

      - name: Checkout validation tool from curation_ops
        uses: actions/checkout@v6
        with:
          repository: ror-community/curation_ops
          path: curation_ops
          sparse-checkout: |
            tests/validate_input_csvs
          sparse-checkout-cone-mode: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: pip

      - name: Install validation tool
        run: pip install -e curation_ops/tests/validate_input_csvs

      - name: Detect and validate CSVs
        id: validate
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          INPUT_DIR="${TARGET_BRANCH}/input_files"
          OUTPUT_DIR="${TARGET_BRANCH}/validation/csvs"
          CSVS_FOUND=""

          # Detect available CSVs
          for csv in new_records_metadata.csv update_records_metadata.csv; do
            if [ -f "${INPUT_DIR}/${csv}" ]; then
              CSVS_FOUND="${CSVS_FOUND} ${INPUT_DIR}/${csv}"
            fi
          done

          if [ -z "$CSVS_FOUND" ]; then
            echo "::warning::No CSV files found to validate in ${INPUT_DIR}"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          mkdir -p "$OUTPUT_DIR"

          # Validate each CSV (word splitting intentional here)
          for csv in $CSVS_FOUND; do
            BASENAME=$(basename "$csv" .csv)
            echo "::group::Validating ${BASENAME}"

            mkdir -p "${OUTPUT_DIR}/${BASENAME}"

            validate-ror-records-input-csvs \
              -i "$csv" \
              -o "${OUTPUT_DIR}/${BASENAME}" \
              -u "${{ secrets.GEONAMES_USER }}" || true

            echo "::endgroup::"
          done

      - name: Commit validation reports
        if: ${{ steps.validate.outputs.found == 'true' }}
        env:
          TARGET_BRANCH: ${{ steps.branch.outputs.target }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${TARGET_BRANCH}/validation/csvs/" || true

          if git diff --staged --quiet; then
            echo "::notice::No validation results to commit"
            exit 0
          fi

          # Count total issues found across all reports
          ISSUE_COUNT=$(find "${TARGET_BRANCH}/validation/csvs" -name "*.csv" -exec tail -n +2 {} \; 2>/dev/null | wc -l | tr -d ' ')

          git commit -m "Add validation reports (${ISSUE_COUNT} issues found) from workflow run #${{ github.run_number }}"
          git pull --rebase origin "$TARGET_BRANCH"
          git push
